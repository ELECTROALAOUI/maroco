<link rel="stylesheet" href="../css/zTree/zTreeStyle.css">
<style type="text/css">
#peopleZTree {
    max-width: 200px;
}
#catalog {
    max-width: 150px;
}
</style>
<div id="peopleZTree" class="x w7 m2 p2 sidebar noscroll">
    <ul id="peopleTree" class="ztree"></ul>
</div>
<div id="peopleViewer" class="row mainbody">
    <div class="toolbar">
        <div class="xr w6">
            <div id="search"></div>
        </div>
        <span id="catalog" class="dicon-org xl caption"></span>
        <span class="b log rock btn-editDepart" title="编辑当前部门"><i class="f f-pencil"></i></span>
        <span class="b note rock btn-addDepart" title="在当前部门添加子部门"><i class="f f-add"></i></span>
        <span class="b error rock btn-delDepar" title="删除当前部门"><i class="f f-bin"></i></span>
        <span class="wall"></span>
        <span class="dicon-user caption"><i class="f f-user"></i> 人员</span>
        <span class="b note rock btn-addPeople" title="在当前部门添加人员"><i class="f f-add"></i></span>
        <span class="b log rock btn-changeDepart" title="为选择的人员更换部门"><i class="f f-tool"></i> 更换部门</span>
        <span class="b error btn-addPeople" title="删除所选人员"><i class="f f-bin"></i></span>
    </div>
    <div id="peoples"></div>
</div>
<script>
seajs.use(['ui', 'ui/ctable', 'ui/searchbox', 'ztree'], function(ctable, searchbox) {
    // var url = _.queryString(location.search);
    var enterpriseId = "";
    //no filter
    $('#search').searchbox({
        placeholder: '在当前部门下查找',
        value: '',
        search: function(value, filter) {
            //回车和点击清空按钮时触发
            console.log(value, filter)
        },
        input: function(value, filter) {
            //键入内容时触发
            console.log(value, filter)
        }
    });
    //ztree
    var orgTree, peopleListTable;
    var setting = {
        data: {
            simpleData: {
                enable: true,
                idKey: 'id',
                pIdKey: 'pid',
                RootPid: 'ROOT'
            }
        },
        view: {
            selectedMulti: false
        },
        callback: {
            onClick: function(event, treeId, treeNode) {
                enterpriseId=treeNode.id;
                $('#catalog').html('<i class="f f-org" title="' + treeNode.name + '"></i> ' + treeNode.name);
                //如果是单位，出现单位功能按钮
                peopleListTable.load({
                    orgId: treeNode.id
                });
            }
        }
    };
    /*= [{
        id: top.USER.orgId,
        isParent: true,
        leaf: false,
        name: top.USER.orgName
    }]*/
    var makePeopleTree = function() {
        $.ajax({
            url: "/json/getTree",
            dataType: 'json',
            success: function(v) {
                var zNodes = v.result;
                $.each(zNodes, function(i, o) {
                    o.icon = '../css/img/org-s.png';
                });
                orgTree = $.fn.zTree.init($("#peopleTree"), setting, zNodes);
                orgTree.expandAll(true);
                $('#peopleTree_1_a').click();
            }

        });
    }
    //成员列表输出
    peopleListTable = ctable({
        container: '#peoples',
        cols: [{
            title: '姓名',
            width: 60
        }, {
            title: '性别',
            width: 50
        }, {
            title: '手机',
            width: 100
        }, {
            title: '邮箱',
            width: 160
        }, {
            title: '职务'
        }, {
            title: '角色',
            width: 100
        }, {
            title: '状态',
            width: 60
        }, {
            title: '操作',
            width: 180
        }],
        checkbox: true,
        height: 'window',
        blankText: '当前部门没有成员',
        //转换 
        render: function(records) {
            return $.map(records, function(record, i) {
                var status = {
                    "0": "未激活",
                    "1": "正常",
                    "2": "冻结",
                    "3": "已删除"
                }
                var title = "登录名:" + record.loginName;
                if (record.reserveB && record.idCard) {
                    title += "\n" + _.escape(record.reserveB + ":" + record.idCard);
                }
                return [
                    ['<a href="javascript:;" class="action-person-view" title="' + title + '">' + record.userName + '</a>',
                        record.sex == 0 ? '男' : '女',
                        record.mobile,
                        record.email,
                        record.position,
                        record.reserveA,
                        status[record.userStatus],
                        '<a href="javascript:;" class="cpr action-person-freeze">' + (record.userStatus == 1 ? "冻结" : "解冻") + '</a>\
                        <a href="userdetails.html?userId=' + record.userId + '" class="cpr action-person-view">编辑</a>\
                        <a href="javascript:;" class="cpr action-person-reset">重置密码</a>\
                        <a href="javascript:;" class="action-person-remove">删除</a>'
                    ]
                ];
            });
        },
        //每页数量
        itemsOnPage: UI.itemsOnPage,
        //加载路径 DATATODO
        url: '/json/getUserByOrgId',
        //需要固定提交的参数
        baseparams: {}
    });
    makePeopleTree();
    //查看人员
    $('#peoples').on('click', '.action-person-view', function() {
            var data = $(this).closest('tr').attr('data-index');
            data = peopleListTable.getData(data);
            top.MENU.open({
                text: data.userName,
                url: 'user/userdetails.html?action=edit&userId=' + data.userId + '&enterpriseId=' + enterpriseId,
                near: true,
                _dofresh: function() {
                    peopleListTable.load();
                }
            });
            return false;
        }).on('click', '.action-person-remove', function() { //查看人员
            var data = $(this).closest('tr').attr('data-index');
            data = peopleListTable.getData(data);
            //todo 企业领导角色必须保留一位


            top.UI.confirm({
                msg: '确定要删除么？',
                type: 'info'
            }, function() {
                $.ajax({
                    url: '../user/deleteUser',
                    type: 'post',
                    dataType: 'json',
                    data: {
                        id: data.userId,
                        enterpriseId: enterpriseId
                    },
                    success: function(data) {
                        peopleListTable.load();
                        if (data.errorCode == 500) {
                            top.UI.notify({
                                msg: data.result,
                                fixed: true,
                                timeout: 2,
                                iconCls: 'error'
                            });
                        } else {
                            top.UI.notify({
                                msg: '操作成功',
                                fixed: true,
                                timeout: 2,
                                iconCls: 'success'
                            });
                        }

                    }
                })

            });
        }).on('click', '.action-person-reset', function() {
            var data = $(this).closest('tr').attr('data-index');
            data = peopleListTable.getData(data);
            top.UI.confirm({
                msg: '确定要重置该用户的密码吗？',
                type: 'info'
            }, function() {
                $.ajax({
                    url: '../user/changePassword',
                    type: 'post',
                    dataType: 'json',
                    data: {
                        userId: data.userId,
                        password: '123456'
                    },
                    success: function() {
                        peopleListTable.load();
                        top.UI.notify({
                            msg: '操作成功',
                            fixed: true,
                            timeout: 2,
                            iconCls: 'success'
                        });
                    }
                })

            });
        })
        .on('click', '.action-person-freeze', function(event) {
            var data = $(this).closest('tr').attr('data-index');
            data = peopleListTable.getData(data);
            var oldStatus = data.userStatus;
            top.UI.confirm({
                msg: '确定要' + (oldStatus == 1 ? "冻结" : "解冻") + '该用户？',
                type: 'info'
            }, function() {
                $.ajax({
                    url: '../user/freezeUseer',
                    type: 'post',
                    dataType: 'json',
                    data: {
                        userId: data.userId,
                        enterpriseId: enterpriseId
                    },
                    success: function(content) {
                        if (content.result != null) {
                            top.UI.notify({
                                msg: content.result,
                                fixed: true,
                                timeout: 2,
                                iconCls: 'error'
                            });
                        }
                        peopleListTable.load();
                    }
                })
            });
        });;


    //编辑部门
    $('.btn-editDepart').click(function() {
            var org = orgTree.getSelectedNodes()[0];
            seajs.use('js/ui.rename', function(rename) {
                rename({
                    title: '编辑部门',
                    value: org.name,
                    //key:'字段名',//不设置则为name
                    //向后端post的其他参数
                    data: {
                        orgId: org.id
                    },
                    url: '../user/updateOrg',
                    //是否启用正则匹配
                    pattern: '^[^\\\\/:*?"<>|]+$',
                    patternText: '不能包含\\/:*?"<>|等特殊字符',
                    callback: function(v, data) {
                        org.name = v;
                        orgTree.updateNode(org);
                    }
                });
            })
        })
        //添加部门
    $('.btn-addDepart').click(function() {
        var org = orgTree.getSelectedNodes()[0];
        seajs.use('js/ui.rename', function(rename) {
            rename({
                title: '添加子部门',
                info: '<span class="dicon-org rock">' + org.name + '</span>',
                //key:'字段名',//不设置则为name
                //向后端post的其他参数
                data: {
                    orgId: org.id
                },
                url: '../user/createOrg',
                //是否启用正则匹配
                pattern: '^[0-9a-zA-Z\u4e00-\u9fa5]+$',
                patternText: '不能包含特殊字符',
                callback: function(v, data) {
                    var newOrg = data.result;
                    newOrg.name = newOrg.orgName;
                    newOrg.icon = '../img/org-s.png';
                    orgTree.addNodes(org, newOrg);
                }
            });
        })
    });
    //删除部门btn-delDepar
    $('.btn-delDepar').click(function() {
        var org = orgTree.getSelectedNodes()[0];
        if (top.USER.orgId === org.id) {
            UI.notify({
                msg: '很抱歉,根部门不可删除！',
                timeout: 2,
                iconCls: 'error'
            });
            return;
        }
        UI.confirm({
            msg: '确定删除部门  "' + org.name + '" 及其所有子部门吗? 删除后成员会转移到根机构下。 '
        }, function() {
            $.ajax({
                url: '../user/deleteOrg',
                type: 'post',
                dataType: 'json',
                data: {
                    orgId: org.id
                },
                success: function(data) {

                    UI.notify({
                        msg: '操作成功',
                        fixed: true,
                        timeout: 2,
                        iconCls: 'success'
                    });

                }
            })
            orgTree.removeNode(org);
        });
    });
    //添加人员
    $('.btn-addPeople').click(function() {
        var org = orgTree.getSelectedNodes()[0];
        top.MENU.open({
            text: '新增人员',
            url: 'user/userdetails.html?action=create' + '&orgId=' + org.id + '&orgName=' + org.name + '&enterpriseId=' + enterpriseId,
            near: true,
            _dofresh: function() {
                peopleListTable.load();
            }
        });
    });

    //更换部门 
    $('.btn-changeDepart').click(function() {
        var org = orgTree.getSelectedNodes()[0];
        var peoples = peopleListTable.getData('selected');
        if (peoples.length == 0) {
            UI.notify({
                msg: '请选择人员',
                timeout: 2,
                iconCls: 'info'
            });
            return;
        }
        top.seajs.use('user/departments', function(depart) {
            depart.show({
                enterpriseId: enterpriseId,
                onselected: function(data) {
                    var people = '';
                    $.each(peoples, function(i, o) {
                        if (i !== 0) people += ',';
                        people += this.userId
                    });
                    var orgs = '';
                    $.each(data, function(i, o) {
                        if (i !== 0) orgs += ',';
                        orgs += this.id
                    });
                    /*                  $.ajax({
                        url:'',
                        data:{
                            user:people,
                            org:orgs
                        }
                    }) */
                    $.ajax({
                        async: false,
                        type: 'post',
                        url: '../user/changeOrg',
                        data: {
                            people: people,
                            org: orgs
                        },
                        dataType: 'json',
                        success: function(data) {
                            UI.notify({
                                msg: '操作成功',
                                fixed: true,
                                timeout: 2,
                                iconCls: 'success'
                            });
                            peopleListTable.load();
                        }
                    });
                }
            });
        })
    });

});
</script>

</html>
