<div class="m13">
    <p class="warn">暂时不要使用table的editable接口，过于复杂，正在优化中...,下面是列冻结示例，实际上是用了两个table实例联合成的</p>
    <div class="row ellipsis">
        <div class="x" id="tableDemoLeft"></div>
        <div class="row" id="tableDemo"></div>
    </div>
</div>
<script>
seajs.use(['ui/table', 'ui/notify'], function(table, notify) {
    var tips=notify.tips;
    //mock table列表
    Mock.mock('fakedata_demo.json', {
        "total|200": 12,
        "result|20": [{
            'id|+1': 12,
            "cname": '@WORD',
            "address": "@TITLE",
            "thumb": '@IMAGE',
            "from": '@STRING(3,8)',
            "sender": '@NAME',
            "sendtime": '@DATE("yyyy-MM-dd")'
        }]
    });
    //mock 单条更新
    Mock.mock('fakedata_demo_update.json', {
        "result": {
            'id|+1': 12,
            "cname": '@WORD',
            "address": "@TITLE",
            "thumb": '@IMAGE',
            "from": '@STRING(3,8)',
            "sender": '@NAME',
            "sendtime": '@DATE("yyyy-MM-dd")'
        }
    });
    // 更多ctable配置接口详见 ui/table.js
    var leftTable = table({
        container: '#tableDemoLeft',
        //排序,参考jqueryui sortable
        sortable: {
            //当有变化的时候触发
            update: function(event, ui) {
                var tbody = ui.item.parent();
                var data = ctable.getData();
                var thisdata = ctable.getData(ui.item.data('index'));
                //忽略新增行动作,新增行的数据只有一个__index__标识
                if (!thisdata.id) return;
                var orders = [];
                tbody.find('tr').each(function(i, o) {
                    var _data = data[$(o).data('index')];
                    //忽略新增行,新增行的数据只有一个__index__标识
                    if (!_data.id) return true;
                    orders.push(_data.id);
                    $(o).find('td:eq(2)').html(orders.length);
                });
                notify.safe('成功更改排序');
            }
        },
        //列配置,title,width,sortable...
        cols: [{
            title: 'ID',
            align: 'center',
            width: 45
        }, {
            title: '冻结列',
            width: 120
        }],
        events: {
            'mouseenter tr': function(e, tr, data, config) {
                ctable.getBody().children().eq($(tr).index()).trigger('mouseenter',{silent:true});
            },
            'mouseleave tr': function(e, tr, data, config) {
                ctable.getBody().children().eq($(tr).index()).trigger('mouseleave',{silent:true});
            }
        },
        //没有render方法的时候，执行cols内部的html
        render: function(records) {
            //这边返回table矩阵[[01,02,03],[11,12,13]] 用于输出的内容
            return _.map(records, function(record, i) {
                return [
                    i + 1,
                    record.cname,
                    record.address,
                    record.sendtime,
                    '<a data-index="' + i + '" href="javascript:;" class="ac-getdata">查看</a>'
                ];
            });
        },
        //是否启用checkbox
        checkbox: true,
        count: 20,
        //自适应屏幕
        height: function(table) {
            return $(window).height() - table.offset().top;
        },
        //滚动同步
        onscroll: function(v, h) {
            if (v !== undefined) {
                ctable.contentEl.trigger('rollbar', [v, h, 1]);
            }
        },
        create: function(api) {
            api.contentEl = this.find('.rollbar-content');
            this.find('.pager').hide();
            this.find('.rollbar-path-vertical').remove();
        }
    });
    var ctable = table({
        container: '#tableDemo',
        //编辑选项
        /*        editable: {
                    beforeAdd: function() {
                        var a = this.find('.ac-tr-save');
                        if (a.length) {
                            // notify.error('请先保存');
                            notify.error({
                                msg: '请先保存',
                                id: 'notify_q2',
                                shadow: false,
                                tips: {
                                    of: a,
                                    dir: 'lc'
                                }
                            });
                            return false;
                        }

                    },
                    beforeEdit: function() {},
                    create: function(inputElements, data, fx, config) {
                        var tr = this;

                    },
                    post: function(data, config) {
                        var changeData = {},
                            isNew;
                        if (data.__index__) {
                            //新增的
                            changeData = data;
                            isNew = true;
                        } else {
                            _.extendOwn(changeData, data);
                        }
                        var tr = this;
                        notify.confirm({
                            test: isNew,
                            msg: '确定更新?',
                            callback: function(b) {
                                if (!b) return;
                                $.ajax({
                                    url: 'fakedata_demo_update.json',
                                    type: 'post',
                                    dataType: 'json',
                                    data: changeddata,
                                    success: function(v) {
                                        ctable.update(tr, v.result);
                                    }
                                });
                            }
                        })
                    },
                    remove: function(data, config) {
                        //this是tr
                        var tr = this;
                        notify.confirm({
                            msg: '确定删除?' + data.id,
                            callback: function(b) {
                                if (!b) return;
                                $.ajax({
                                    url: 'fakedata_demo_update.json',
                                    type: 'post',
                                    dataType: 'json',
                                    data: {
                                        id: data.id
                                    },
                                    success: function(v) {
                                        //ps:cache中依然存在此data数据 可考虑使用 ctable.load()刷新
                                        tr.remove();
                                    }
                                });
                            }
                        })
                    }
                },*/
        //列配置,title,width,sortable...
        cols: [{
            title: '人员',
            align: 'center',
            width: 120
        }, {
            title: '功能需求',
            width: 200,
            // colgroup: "组合",
            //需要排序
            order: 'cname',
            //编辑选项
            field: {
                //值通过其他字段计算得出
                fx: function() {
                    return this.from + this.address
                }
            },
            width: 120
        }, {
            title: ' 方法调用',
            width: 420,
            // colgroup: "组合",
            field: {
                //带name的表示可编辑字段,必须和后端返回的值一样，用post传递到后端
                name: 'address',
                //自定义输入框
                render: function(editableConfig, suggestRender) {
                    return '<div class="text-auto">\
                            <select name="address" class="text">\
                            <option value="API1">API1</option>\
                            <option value="2">2</option>\
                            <option value="3">3</option>\
                            </select></div>';
                }
            }
        }, {
            title: '交单时间',
            //需要排序k
            order: 'sendtime',
            width: 120
        }, {
            title: '操作',
            width: 520
        }],
        events: {
            'click .ac-getdata': function(event, tr, data, config) {
                console.log(data);
            },
            'mouseenter tr': function(e, tr, data, config) {
                leftTable.getBody().children().eq($(tr).index()).trigger('mouseenter',{silent:true});
            },
            'mouseleave tr': function(e, tr, data, config) {
                leftTable.getBody().children().eq($(tr).index()).trigger('mouseleave',{silent:true});
            }
        },
        //没有render方法的时候，执行cols内部的html
        render: function(records) {
            //这边返回table矩阵[[01,02,03],[11,12,13]] 用于输出的内容
            return _.map(records, function(record, i) {
                return [
                    i + 1,
                    record.cname,
                    record.address,
                    record.sendtime,
                    '<a data-index="' + i + '" href="javascript:;" class="ac-getdata">查看</a>'
                ];
            });
        },
        //处理从url返回的数据,无此参数则默认返回data.result;
        parseData: function(data) {
            //这里可以在数据显示前进行一些更改
            return data.result;
        },
        status: $.noop,
        //数据加载后执行
        afterLoad: function(data, cache) {
            // leftTable.append(data.result);
            leftTable.config.loader.afterLoad(data);
        },
        //自适应屏幕
        // height: 'window',
        //是否启用checkbox
        checkbox: false,
        height: function(table) {
            return $(window).height() - table.offset().top;
        },
        //滚动同步
        onscroll: function(v, h) {
            if (v !== undefined) {
                leftTable.contentEl.trigger('rollbar', [v, h, 1]);
            }
        },
        //每页数量
        count: 20,
        //加载路径
        url: 'fakedata_demo.json',
        //需要固定提交的参数
        baseparams: {
            token: 'FFASLE*&EFFA^%$#ef'
        },
        create: function(api) {
            api.contentEl = this.find('.rollbar-content');
        }
    });
    ctable.load();
});
</script>
