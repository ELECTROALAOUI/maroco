define("js/ui/uploader",["ui/notify"],function(e,i,o){var s=e("ui/notify"),t=UI.browser.chrome,a=window.File&&window.FileReader&&window.FileList&&window.Blob,l=s({title:"上传文件",cls:"link",draggable:!0,dropTip:'<div class="text-center c-gray" style="width:100%;top:130px;left:0;z-index:10;position:absolute;"><h2 style="font-size:20px;">试试将文件'+(t?"或文件夹":"")+"拖拽到屏幕上上传</h2><div>(您的浏览器支持拖拽上传)</div></div>",msg:'<b class="b note ac-upload va-m m2">上传文件</b>'+(t?'<input type="file" webkitdirectory="" hidden><b class="b note ac-upload-folder va-m">上传文件夹</b>':"")+'<span class="ac-path c-gray ellipsis ml"></span><div class="m1 scroll ac-showcase" style="height:250px;position:relative;border:solid 1px #e4e5e9;background:#FAFBFE"></div>',mask:!0,width:550,events:{"click .ac-cancel":function(e,i){var o=i.uploader,s=o.getFile($(this).data("id"));return s&&(s.dom.fadeOut(function(){$(this).remove()}),o.removeFile(s)),!1}},buttons:[{label:"取消",cls:"silver ac-btncancel",click:"close"},{label:"完成",cls:"silver ac-btnfinish",click:"finish"}],ellipsis:function(e,i){return e?(i=i||20,e.length>i?"到：... "+e.slice(-i):"到："+e):""},i18n:{"Stop Upload":"停止上传","Upload URL might be wrong or doesn't exist.":"上传的URL可能是错误的或不存在。",tb:"TB",Size:"大小",Close:"关闭","Init error.":"初始化错误。","Add files to the upload queue and click the start button.":"将文件添加到上传队列，然后点击”开始上传“按钮。",Filename:"文件名","Image format either wrong or not supported.":"图片格式错误或者不支持。",Status:"状态","HTTP Error.":"HTTP 错误。","Start Upload":"开始上传",mb:"MB",kb:"KB","Duplicate file error.":"重复文件错误。","File size error.":"文件体积太大。","N/A":"N/A",gb:"GB","Error: Invalid file extension:":"错误：无效的文件扩展名:","Select files":"选择文件","%s already present in the queue.":"%s 已经在当前队列里。","File: %s":"文件: %s",b:"B","Uploaded %d/%d files":"已上传 %d/%d 个文件","Upload element accepts only %d file(s) at a time. Extra files were stripped.":"每次只接受同时上传 %d 个文件，多余的文件将会被删除。","%d files queued":"%d 个文件加入到队列","File: %s, size: %d, max file size: %d":"文件: %s, 大小: %d, 最大文件大小: %d","Drag files here.":"把文件拖到这里。","Runtime ran out of available memory.":"运行时已消耗所有可用内存。","File count error.":"文件数量错误。","File extension error.":"文件类型错误。","Error: File too large:":"错误: 文件太大:","Add Files":"增加文件"},show:function(i){var o=this;o.mask.appendTo("body").show(),o.el.position(o.position),o.path.html(o.ellipsis(i.uploadPath)),o.footLabel.html(i.footLabel),e.async("js/vendor/plupload/plupload.full.min.js",function(){var n=o.$(".ac-upload");if(o.i18n&&(plupload.addI18n(o.i18n),delete o.i18n,a&&(o.dropTip=$(o.dropTip).insertBefore(o.showcase),t))){var r=n.next().change(function(){o.uploader.addFile(this)});r.next().click(function(){return r.trigger("click"),!1})}o.uploader=new plupload.Uploader(_.extend({browse_button:n[0],url:"/",drop_element:o.mask[0],runtimes:"html5,flash",max_file_size:"100mb",flash_swf_url:e.resolve("../")+"vendor/plupload/Moxie.swf",beforeUploaded:$.noop,uploaded:$.noop,complete:$.noop,init:{FilesAdded:function(e,i){o.dropTip.hide&&o.dropTip.hide(),l.add(i),e.start()},QueueChanged:function(e){l.btnCancel.show(),l.btnFinish.hide()},BeforeUpload:function(e,i){e.settings.beforeUploaded(e,i)},UploadProgress:function(e,i){i.bar.width(i.percent+"%"),i.pcnt.html(i.percent+"%")},FileUploaded:function(e,i,o){if(o=JSON.parse(o.response),!o.success)return void e.trigger("Error",{code:"sugon",message:o.msg,file:i});e.removeFile(i);var s=e.settings;i.bar.parent().parent().html('<img style="position:absolute;margin:-22px 0 0 -22px;" src="'+UI.server+'cloud/img/ok.png">成功上传'+l.ellipsis(s.uploadPath,30)),s.uploaded(e,i,o)},UploadComplete:function(e,i){l.btnCancel.hide(),l.btnFinish.show(),e.settings.complete(e,i)},Error:function(e,i){var o=i.file;o?(o.dom?e.removeFile(o):l.add([o]),o.bar.parent().parent().html('<div class="c-error">'+(-600==i.code?"文件大小超过"+e.settings.filters.max_file_size+'，建议使用<a target="_blank" href="#" onclick="ls.startIMClient();">客户端</a>，高速、稳定':i.message)+"</div>"),o.dom.addClass("ac-error")):s.error(i.message)}}},i)),o.uploader.init()})},hide:function(){this.mask.hide(),this.uploader&&this.uploader.destroy()},close:function(e,i){i=i||this;var o=i.uploader;o.total.queued?confirm("确定取消所有正在上传的文件？")&&i.finish():i.finish()},finish:function(e,i){i=i||this,this.showcase.empty(),i.dropTip.show&&i.dropTip.show();var o=i.uploader;_.each(o.files,function(e){e&&o.removeFile(e)}),i.hide()},oncreate:function(){var e=this;e.path=e.$(".ac-path"),e.showcase=e.$(".ac-showcase"),e.footLabel=$('<div class="xl m1"></div>'),e.contentEl.addClass("p10").next().prepend(e.footLabel),e.btnCancel=e.$(".ac-btncancel").hide(),e.btnFinish=e.$(".ac-btnfinish")},add:function(e){this.dropTip.hide&&this.dropTip.hide(),$.each(e,function(e,i){i.dom=$('<div id="'+i.id+'" class="xc" style="margin-top:-1px;border-top:solid 1px #e4e5e9;padding:10px 10px 10px 30px"><span class="xr">'+plupload.formatSize(i.size)+'</span><div class="ellipsis w13"><strong>'+i.name+'</strong></div><div class="xc" style="height:30px;padding-top:6px;"><div class="progress w11 xl" style="height:10px;margin:5px 10px 0 0;"><div class="bar safe"></div></div><span class="ac-percent xl"></span><a href="#" class="ac-cancel xr" data-id="'+i.id+'">取消</a></div></div>'),i.bar=i.dom.find(".bar"),i.pcnt=i.dom.find(".ac-percent"),l.showcase.append(i.dom)})}});return l});