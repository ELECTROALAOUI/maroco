define("js/ui/table",["mousewheel","ui/rollbar","ui/pager"],function(e,t,a){"use strict";e("mousewheel"),e("ui/rollbar");var c=e("ui/pager"),o='<b class="i i-safe ac-tr-save m2" title="保存"></b><b class="i i-close ac-tr-cancel" title="取消"></b>',l=_.dot('<div class="text-auto-wrap"><input name="{{=it.name}}" value="{{=it.value}}" data-trim="true" data-describedby="tooltip" type="text" class="text-auto" {{=it.attr}}></div>'),r='{{?it.sortable}}            <col width="10">        {{?}}        {{?it.checkbox}}            <col width="34">        {{?}}        {{~it.cols :col:index}}            <col class="{{=col.cls||""}}" width="{{=col.width||""}}" {{?col.background}}style="background:{{=col.background}}"{{?}}>        {{~}}        {{?it.editable}}            <col width="80">        {{?}}',n='<thead>{{?!it._colgroup}}        <tr>            {{?it.sortable}}            <th class="chandler"></th>            {{?}}            {{?it.checkbox}}            <th align=left><input type="checkbox" class="ctable-checkall"></th>            {{?}}            {{~it.cols :col:index}}            <th align="{{=col.align||"left"}}" class="{{=col.cls||""}} {{=col.order?"order":""}}"{{?col.order}} order="{{=col.order}}"{{?}}{{?col.style}} style="{{=col.style}}"{{?}}>{{=col.title||""}}{{?col.order}} <i class="order-tip"></i>{{?}}</th>            {{~}}            {{?it.editable}}            <th class="text-center"><b class="f f-add ac-tr-add"></b></th>            {{?}}        </tr>        {{??}}        <tr>            {{?it.sortable}}            <th class="chandler" rowspan="2"></th>            {{?}}            {{?it.checkbox}}            <th rowspan="2" align=left><input type="checkbox" class="ctable-checkall"></th>            {{?}}            {{~it.cols :col:index}}                {{?col.colspan}}                <th index="{{=index+=col.colspan-1}}" colspan="{{=col.colspan}}" class="ctable-colgroup" align="center">{{=col.colgroup}}</th>                {{??}}                <th rowspan="2" align="{{=col.align||"left"}}" class="{{=col.cls||""}} {{=col.order?"order":""}}"{{?col.order}} order="{{=col.order}}"{{?}}{{?col.style}} style="{{=col.style}}"{{?}}>{{=col.title||""}}{{?col.order}} <i class="order-tip"></i>{{?}}</th>                {{?}}            {{~}}            {{?it.editable}}            <th rowspan="2" class="text-center"><b class="f f-add ac-tr-add"></b></th>            {{?}}        </tr>        <tr>            {{~it.cols :col:index}}            {{?col.colgroup}}            <th align="{{=col.align||"left"}}" class="ctable-colgroup {{=col.cls||""}} {{=col.order?"order":""}}"{{?col.order}} order="{{=col.order}}"{{?}}{{?col.style}} style="{{=col.style}}"{{?}}>{{=col.title||""}}{{?col.order}} <i class="order-tip"></i>{{?}}</th>            {{?}}            {{~}}        </tr>        {{?}}        </thead>',i=_.dot('<div class="ctable {{=it.skin||""}}" id="{{=it.id||""}}">        {{?!it.hidehead}}        <div class="ctable-head"><table>'+r+n+'</table></div>        {{?}}        <div class="ctable-body" id="{{=it.cscrollId}}">        <table>'+r+'<tbody></tbody></table>        </div>        {{?it.count}}        <div class="ctable-foot">        <div class="ctable-status"></div>        <div class="pager"></div></div>        {{?}}        </div>'),d=_.dot('{{~it.data :trdata:index}}        <tr class="{{=index%2==0?"even":"odd"}}" data-index="{{=trdata.__index__||(it.__appendIndex__||0)+index}}">        {{?it.sortable}}            <td class="chandler"></td>        {{?}}        {{?it.checkbox}}            <td><input type="checkbox" class="ctable-checkbox"{{?it.checkbox(trdata)}} checked{{?}}></td>        {{?}}        {{~it.cols :col:colindex}}            <td {{?col.align}}align="{{=col.align}}"{{?}} {{?col.cls}}class="{{=col.cls||""}}"{{?}} {{?col.style}}style="{{=col.style}}"{{?}}>{{=trdata[colindex]===undefined||trdata[colindex]===null?"":trdata[colindex]}}</td>        {{~}}        {{?it.editable}}            <td class="p0 text-center">{{?trdata.__index__!==undefined}}'+o+'{{??}}            <b class="f f-pencil ac-tr-edit c-note m2 ctable-hide" title="编辑"></b>            <b class="f f-bin ac-tr-remove c-error ctable-hide" title="删除"></b>            {{?}}</td>        {{?}}        </tr>        {{~}}'),s={checked:!1,sortable:!1,status:function(e,t,a){return"共 "+e+" 条数据"},parseData:function(e){return e.result}};return function(t){function a(e){u.height(e),t.hidehead||(e-=f.height()),t.count&&(e-=30),b.height(e)}t=_.extend({},s,t,{skipIndex:(t.checkbox?1:0)+(t.sortable?1:0),cscrollId:_.uniqueId("tableRoll")});var r=t.skipIndex;t._colgroup=!1;var n,h=0;$.each(t.cols,function(e,a){_.isNumber(a.width)&&UI.browser.ie<8&&(a.width-=16),h+=a.width,a.colspan&&delete a.colspan,a.colgroup&&(n&&n.colgroup===a.colgroup?n.colspan=n.colspan?n.colspan+1:2:n=a,t._colgroup=!0)}),t.checkbox&&!$.isFunction(t.checkbox)&&(t.checkbox=$.noop);var u=$(i(t)),b=u.find(">.ctable-body"),p=u.find(">.ctable-head"),f=p.find("thead"),v=b.find("tbody"),x=u.find(">.ctable-foot"),g=x.find(".ctable-status"),m=x.find(".pager"),k=f.find(".ctable-checkall")[0]||{};$(t.container).append(u),f.on("click",".order",function(e){e.stopPropagation();var a="asc",c=$(this);c.hasClass("desc")?c.removeClass("desc"):c.hasClass("asc")?(a="desc",c.addClass("desc")):c.addClass("asc"),c.siblings().removeClass("asc desc"),_.extend(t.baseparams,{order:c.attr("order"),asc:a}),D.load()}),t.sortable&&e.async("sortable",function(){v.sortable($.extend({handle:".chandler",start:$.noop,sort:$.noop,stop:$.noop,update:$.noop},t.sortable))}),t.checkbox&&($(k).on("click",function(e){e.stopPropagation();var a=this.checked;v.find(".ctable-checkbox").each(function(e,t){t.checked=a}),t.onselect&&t.onselect.call(this,this.checked?I:[])}),v.on("click",".ctable-checkbox",function(e){e.stopPropagation();var a=!0;if(v.find(".ctable-checkbox").each(function(e,t){return t.checked?void 0:(a=!1,!1)}),k.checked=a,t.onselect){var c=$(this).closest("tr").attr("data-index");t.onselect.call(this,A.getData("selected"),I[c])}}));var y=function(e,t){if(e&&e.name){if(e.render){var a=e.render(e,l,t);if(a)return a}var c=t?t[e.name]:"";return c=void 0===c||null===c?"":c,l({name:e.name,attr:e.attr||"",value:c})}return""},w=t.editable;w&&(_.defaults(w,{beforeAdd:$.noop,beforeEdit:$.noop,create:$.noop,post:$.noop,remove:$.noop}),f.on("click",".ac-tr-add",function(){if(w.beforeAdd.call(u)===!1)return!1;var e={},a=$.map(t.cols,function(e,t){return y(e.field)});a.__index__=e.__index__=I.length,I[a.__index__]=e,t.data=[a];var c=$(d(t)).prependTo(v);w.create.call(c,e,t)}),v.on("click",".ac-tr-edit",function(e){e.stopPropagation();var a=$(this).closest("tr"),c=I[a.attr("data-index")];if(w.beforeEdit.call(a,c)===!1)return!1;var l=_.create(c),n=a.find(">td");c.__html__=a.html(),c.__param__=l,$(this).parent().html(o),$.each(t.cols,function(e,t){var a=t.field;if(a&&a.name){var o=y(a,c);n.eq(e+r).html(o)}}),w.create.call(a,l,t)}).on("click",".ac-tr-save",function(){var e=$(this).closest("tr"),a=e.attr("data-index"),c=I[a];w.post.call(e,c,t)}).on("click",".ac-tr-cancel",function(){var e=$(this).closest("tr"),t=I[e.attr("data-index")];return $.isNumeric(t.__index__)?void e.remove():(e.html(t.__html__),delete t.__html__,void delete t.__param__)}).on("click",".ac-tr-remove",function(){var e=$(this).closest("tr"),a=e.attr("data-index"),c=I[a];t.remove.call(e,c,t)})),v.on("mouseenter","tr",function(){$(this).addClass("ctable-hover")}).on("mouseleave","tr",function(){$(this).removeClass("ctable-hover")}),t.events&&$.each(t.events,function(e,a){var c=e.indexOf(" ");2>c||v.on(e.substr(0,c),e.substr(c+1),function(e,c){if(!c||!c.silent){var o=$(this).closest("tr"),l=o.attr("data-index"),r=I[l];return a.call(this,e,o,r,t,I)===!1?!1:void 0}})});var I=[];if(t.height){if(_.isFunction(t.height)){var C=_.throttle(function(){document.getElementById(t.cscrollId)?a(t.height(u)):$(window).off("resize",C)},500,{leading:!1});$(window).on("resize",C),a(t.height(u))}else t.height&&a(t.height);h&&(f.parent().width(h),v.parent().width(h)),$("#"+t.cscrollId).rollbar({scrollamount:t.scrollamount||100,shadow:!0,onscroll:function(e,a){void 0!==a&&(p[0].scrollLeft=a),t.onscroll&&t.onscroll(e,a)}})}var L=function(e,a){var c=e.attr("data-index");I[c]=_.extend(I[c],a),t.data=t.render([I[c]]),e.html($(d(t)).html())},P=c({el:m,onPageClick:function(e,t){D.page=t,D.load()}});t.count||m.hide();var D=t.loader=UI.loader({baseparams:t.baseparams,count:t.count,loadtip:t.loadtip,url:t.url,cache:t.cache,beforeLoad:function(e){t.beforeLoad&&t.beforeLoad.call(u,e,t)},afterLoad:function(e){if(I=t.parseData(e)||[],0===I.length&&this.page>1)return this.page=this.page-1,void this.load();t.data=t.render(I);var a=d(t);k.checked=!1,setTimeout(function(){v.html(a),t.afterLoad&&t.afterLoad.call(u,e,I)},20),t.count&&P.render(e.total,D.page,D.count),g.html(t.status(e.total,D.page,D.count)||"")}}),A={config:t,table:u,load:function(e,t){t&&_.extend(D.baseparams,t===!0?e:t),D.load(e)},getBody:function(){return v},getData:function(e){if($.isNumeric(e))return I[e];var t=[];return"selected"===e?(v.find(".ctable-checkbox").each(function(e,a){a.checked&&t.push(I[e])}),t):(v.children().each(function(e,a){t.push(I[$(a).attr("data-index")])}),t)},getSelectedRow:function(){return v.find(".ctable-checkbox:checked").parent().parent()},update:L,append:function(e){if(e instanceof Array||(e=[e]),0!=e.length){t.__appendIndex__=I.length,$.each(e,function(e,t){I[I.length]=t}),t.data=t.render(e);var a=$(d(t)).appendTo(v);return delete t.__appendIndex__,k.checked=!1,a}},reset:function(){I=[],v.empty(),g.empty(),P.render(0)}};return t.create&&t.create.call(u,A),A}});